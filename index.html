<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mis Destinos Pro</title>
    <style>
        :root { --primary: #3498db; --bg: #f4f7f6; --text: #2c3e50; --danger: #e74c3c; --success: #2ecc71; --dark: #34495e; }
        body { font-family: -apple-system, system-ui, sans-serif; background-color: var(--bg); margin: 0; color: var(--text); }
        
        .screen { display: none; padding: 20px; box-sizing: border-box; min-height: 100vh; }
        .active { display: block; }

        .top-bar { display: flex; gap: 8px; margin-bottom: 15px; }
        .btn-top { 
            flex: 1; padding: 12px 2px; border-radius: 12px; border: none; 
            background: white; color: var(--dark); font-size: 11px; font-weight: bold;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06); cursor: pointer;
        }

        /* Mapa con Carga Diferida */
        .map-container {
            width: 100%; height: 300px; border-radius: 20px; overflow: hidden;
            margin-bottom: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            background: #e5e3df; border: 2px solid white; position: relative;
        }
        .map-loading {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            font-size: 14px; color: #7f8c8d; font-weight: bold; z-index: 1;
        }
        .map-container iframe { width: 100%; height: 100%; border: none; position: relative; z-index: 2; }

        /* Lista */
        h1 { text-align: center; font-size: 1.5rem; margin: 10px 0 20px 0; font-weight: 800; }
        .trip-card {
            background: white; padding: 12px; margin-bottom: 15px; border-radius: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05); display: flex; align-items: center;
        }
        .thumb { width: 65px; height: 65px; border-radius: 15px; object-fit: cover; margin-right: 12px; background: #eee; border: 2px solid #fff; flex-shrink: 0; }
        .card-info { flex-grow: 1; }
        .card-title { font-weight: bold; font-size: 1.1rem; }
        .card-meta { font-size: 0.85rem; color: var(--primary); font-weight: 600; }

        /* Detalles */
        #preview-img { width: 220px; height: 220px; border-radius: 35px; object-fit: cover; border: 6px solid white; box-shadow: 0 8px 25px rgba(0,0,0,0.15); background: #ddd; }
        label { display: block; margin-top: 15px; font-weight: bold; font-size: 0.75rem; color: #7f8c8d; text-transform: uppercase; }
        input, textarea { width: 100%; margin-top: 5px; padding: 12px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; }
        
        .url-group { display: flex; gap: 5px; margin-top: 8px; }
        .btn-action { width: 40px; height: 40px; border: none; border-radius: 10px; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; }
        
        .add-btn-main { position: fixed; bottom: 30px; right: 30px; background: var(--primary); color: white; width: 60px; height: 60px; border-radius: 50%; font-size: 35px; border: none; box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 10; }
    </style>
</head>
<body>

<div id="list-screen" class="screen active">
    <div class="top-bar">
        <button class="btn-top" onclick="syncFromGitHub()">üîÑ Sync Raw</button>
        <button class="btn-top" onclick="exportJSON()">üì§ Guardar</button>
        <button class="btn-top" onclick="document.getElementById('import-input').click()">üì• Importar</button>
        <input type="file" id="import-input" style="display:none" onchange="importJSON(this)">
    </div>

    <div class="map-container">
        <div class="map-loading">Cargando mapa...</div>
        <iframe id="main-map" data-src="https://www.google.com/maps/d/u/0/embed?mid=1FATKt49yvCmEUAieYpCZsyYnyydIr9U&ehbc=2E312F"></iframe>
    </div>

    <h1>üåç Mis Destinos</h1>
    <div id="trips-container"></div>
    <button class="add-btn-main" onclick="openDetails(null)">+</button>
</div>

<div id="detail-screen" class="screen">
    <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
        <button onclick="showList()">Volver</button>
        <button onclick="saveTrip()" style="background:var(--primary); color:white; border:none; padding:10px 20px; border-radius:10px;">Guardar</button>
    </div>
    <div style="text-align:center;">
        <img id="preview-img" src="" onclick="document.getElementById('file-input').click()">
        <input type="file" id="file-input" style="display:none" accept="image/*" onchange="handleFile(this)">
    </div>
    <label>Destino</label><input type="text" id="edit-title">
    <div style="display:flex; gap:10px;">
        <div style="flex:1;"><label>Provincia</label><input type="text" id="edit-provincia"></div>
        <div style="flex:1;"><label>KM</label><input type="number" id="edit-km"></div>
    </div>
    <label>Enlaces Web</label><div id="urls-container"></div>
    <label>Notas</label><textarea id="edit-notes" rows="4"></textarea>
    <input type="hidden" id="edit-index">
</div>

<script>
    const GITHUB_USER = "antoniodetm"; 
    const FILENAME = "mis-destinos.json";
    let trips = JSON.parse(localStorage.getItem('myTrips')) || [];
    let currentBase64 = "";

    // L√≥gica del Mapa
    window.addEventListener('load', () => {
        setTimeout(() => {
            const map = document.getElementById('main-map');
            map.src = map.getAttribute('data-src');
            map.onload = () => document.querySelector('.map-loading').style.display = 'none';
        }, 600);
    });

    // --- SINCRONIZACI√ìN GITHUB ---
    async function syncFromGitHub() {
        const rawUrl = `https://raw.githubusercontent.com/${GITHUB_USER}/mis-destinos/main/${FILENAME}`;
        try {
            const response = await fetch(rawUrl + '?nocache=' + new Date().getTime());
            if (!response.ok) throw new Error("No se pudo obtener el archivo");
            const data = await response.json();
            if (confirm("¬øSobrescribir datos locales con los de GitHub?")) {
                trips = data;
                saveAndRefresh();
                alert("‚úÖ Datos sincronizados correctamente");
            }
        } catch (err) {
            alert("‚ùå Error al conectar con GitHub: " + err.message);
        }
    }

    function renderTrips() {
        const container = document.getElementById('trips-container');
        container.innerHTML = trips.length ? '' : '<p style="text-align:center; color:gray;">Sin destinos.</p>';
        trips.forEach((t, i) => {
            container.innerHTML += `
                <div class="trip-card">
                    <img src="${t.img || ''}" class="thumb" onclick="openDetails(${i})">
                    <div class="card-info" onclick="openDetails(${i})">
                        <span class="card-title">${t.title}</span>
                        <div class="card-meta">üìç ${t.provincia || '--'} ‚Ä¢ üöó ${t.km || 0} km</div>
                    </div>
                    <button onclick="deleteTrip(${i})" style="border:none; background:none; color:#ffbcbc; padding:10px; font-size:18px;">üóëÔ∏è</button>
                </div>`;
        });
    }

    function addUrlField(v = '') {
        const c = document.getElementById('urls-container');
        const d = document.createElement('div');
        d.className = 'url-group';
        d.innerHTML = `<input type="url" class="trip-url" value="${v}" style="flex:1"><button class="btn-action" style="background:var(--primary)" onclick="window.open(this.previousSibling.value.startsWith('http') ? this.previousSibling.value : 'https://' + this.previousSibling.value)">‚ûú</button><button class="btn-action" style="background:var(--danger)" onclick="this.parentElement.remove()">‚úï</button><button class="btn-action" style="background:var(--success)" onclick="addUrlField()">+</button>`;
        c.appendChild(d);
    }

    function openDetails(idx) {
        document.getElementById('list-screen').classList.remove('active');
        document.getElementById('detail-screen').classList.add('active');
        document.getElementById('urls-container').innerHTML = '';
        if(idx !== null) {
            const t = trips[idx];
            document.getElementById('edit-title').value = t.title || "";
            document.getElementById('edit-provincia').value = t.provincia || "";
            document.getElementById('edit-km').value = t.km || "";
            document.getElementById('edit-notes').value = t.notes || "";
            document.getElementById('preview-img').src = t.img || "";
            currentBase64 = t.img || "";
            document.getElementById('edit-index').value = idx;
            if(t.urls && t.urls.length) t.urls.forEach(u => addUrlField(u)); else addUrlField();
        } else {
            document.getElementById('edit-index').value = "new";
            document.getElementById('edit-title').value = "";
            document.getElementById('edit-provincia').value = "";
            document.getElementById('edit-km').value = "";
            document.getElementById('edit-notes').value = "";
            document.getElementById('preview-img').src = "";
            currentBase64 = "";
            addUrlField();
        }
    }

    function saveTrip() {
        const title = document.getElementById('edit-title').value;
        if (!title) return;
        const u = Array.from(document.querySelectorAll('.trip-url')).map(i => i.value).filter(v => v.trim() !== "");
        const data = { title, provincia: document.getElementById('edit-provincia').value, km: document.getElementById('edit-km').value, img: currentBase64, urls: u, notes: document.getElementById('edit-notes').value };
        const idx = document.getElementById('edit-index').value;
        if(idx === "new") trips.push(data); else trips[idx] = data;
        saveAndRefresh();
        showList();
    }

    function deleteTrip(i) { if(confirm("¬øBorrar?")) { trips.splice(i,1); saveAndRefresh(); } }
    function saveAndRefresh() { localStorage.setItem('myTrips', JSON.stringify(trips)); renderTrips(); }
    function showList() { document.getElementById('detail-screen').classList.remove('active'); document.getElementById('list-screen').classList.add('active'); }
    function handleFile(i) { const r = new FileReader(); r.onload = (e) => { currentBase64 = e.target.result; document.getElementById('preview-img').src = currentBase64; }; r.readAsDataURL(i.files[0]); }
    function exportJSON() { const b = new Blob([JSON.stringify(trips, null, 2)], {type:"application/json"}); const a = document.createElement("a"); a.href=URL.createObjectURL(b); a.download=FILENAME; a.click(); }
    function importJSON(input) { const r = new FileReader(); r.onload = (e) => { try { trips = JSON.parse(e.target.result); saveAndRefresh(); } catch(i){ alert("Error"); } }; r.readAsText(input.files[0]); }

    renderTrips();
</script>
</body>
</html>