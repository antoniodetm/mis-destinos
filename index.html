<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mis Destinos Pro</title>
    <style>
        :root { --primary: #3498db; --bg: #f4f7f6; --text: #2c3e50; --danger: #e74c3c; --success: #2ecc71; --dark: #34495e; }
        body { font-family: -apple-system, system-ui, sans-serif; background-color: var(--bg); margin: 0; color: var(--text); }
        
        .screen { display: none; padding: 20px; box-sizing: border-box; min-height: 100vh; }
        .active { display: block; }

        /* Barra Superior */
        .top-bar { display: flex; gap: 8px; margin-bottom: 15px; }
        .btn-top { 
            flex: 1; padding: 12px 2px; border-radius: 12px; border: none; 
            background: white; color: var(--dark); font-size: 11px; font-weight: bold;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06); cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 4px;
        }

        /* Mapa MyMaps */
        .map-container {
            width: 100%; height: 350px; border-radius: 20px; overflow: hidden;
            margin-bottom: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            background: #e5e3df; border: 2px solid white;
        }
        .map-container iframe { width: 100%; height: 100%; border: none; }

        /* Lista Principal */
        h1 { text-align: center; font-size: 1.5rem; margin: 10px 0 20px 0; font-weight: 800; }
        .trip-card {
            background: white; padding: 12px; margin-bottom: 15px; border-radius: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05); display: flex; align-items: center;
        }
        
        .thumb { width: 65px; height: 65px; border-radius: 15px; object-fit: cover; margin-right: 12px; background: #eee; flex-shrink: 0; cursor: pointer; border: 2px solid #fff; }
        .card-info { flex-grow: 1; cursor: pointer; }
        .card-title { font-weight: bold; font-size: 1.1rem; color: #333; display: block; }
        .card-meta { font-size: 0.85rem; color: var(--primary); font-weight: 600; margin-top: 2px; }

        .card-controls { display: flex; flex-direction: column; gap: 4px; margin-left: 10px; border-left: 1px solid #eee; padding-left: 10px; }
        .order-btn { background: none; border: none; font-size: 14px; color: #ccc; cursor: pointer; }
        .delete-quick { color: #ffbcbc; border: none; background: none; font-size: 14px; cursor: pointer; }

        /* Pantalla Detalles - FOTO GRANDE */
        .header-detail { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .btn { padding: 10px 20px; border-radius: 12px; border: none; font-weight: bold; }
        .btn-back { background: #eee; color: #666; }
        .btn-save { background: var(--primary); color: white; }
        
        .profile-pic-container { text-align: center; margin-bottom: 25px; }
        #preview-img { width: 220px; height: 220px; border-radius: 35px; object-fit: cover; border: 6px solid white; box-shadow: 0 8px 25px rgba(0,0,0,0.15); cursor: pointer; background: #ddd; }
        
        label { display: block; margin-top: 15px; font-weight: bold; font-size: 0.75rem; text-transform: uppercase; color: #7f8c8d; }
        input, textarea { width: 100%; margin-top: 5px; padding: 12px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; font-size: 15px; }
        
        /* Enlaces Web */
        .url-group { display: flex; gap: 5px; margin-top: 8px; align-items: center; }
        .btn-action { width: 40px; height: 40px; border: none; border-radius: 10px; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; }
        .btn-remove { background: var(--danger); }
        .btn-add-inline { background: var(--success); }
        .btn-go { background: var(--primary); }

        .add-btn-main { position: fixed; bottom: 30px; right: 30px; background: var(--primary); color: white; width: 60px; height: 60px; border-radius: 50%; font-size: 35px; border: none; box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 10; }
    </style>
</head>
<body>

<div id="list-screen" class="screen active">
    <div class="top-bar">
        <button class="btn-top" onclick="syncFromGitHub()">üîÑ Sync Raw</button>
        <button class="btn-top" onclick="exportJSON()">üì§ Guardar JSON</button>
        <button class="btn-top" onclick="document.getElementById('import-input').click()">üì• Importar</button>
        <input type="file" id="import-input" style="display:none" accept=".json" onchange="importJSON(this)">
    </div>

    <div class="map-container">
        <iframe src="https://www.google.com/maps/d/u/0/embed?mid=1FATKt49yvCmEUAieYpCZsyYnyydIr9U&ehbc=2E312F"></iframe>
    </div>

    <h1>üåç Mis Destinos</h1>
    <div id="trips-container"></div>
    <button class="add-btn-main" onclick="openDetails(null)">+</button>
</div>

<div id="detail-screen" class="screen">
    <div class="header-detail">
        <button class="btn btn-back" onclick="showList()">Volver</button>
        <button class="btn btn-save" onclick="saveTrip()">Guardar</button>
    </div>
    <div class="profile-pic-container">
        <img id="preview-img" src="" onclick="document.getElementById('file-input').click()">
        <input type="file" id="file-input" style="display:none" accept="image/*" onchange="handleFile(this)">
    </div>
    
    <label>Nombre del Destino</label>
    <input type="text" id="edit-title">

    <div style="display:flex; gap:10px;">
        <div style="flex:1;"><label>Provincia</label><input type="text" id="edit-provincia"></div>
        <div style="flex:1;"><label>KM</label><input type="number" id="edit-km"></div>
    </div>
    
    <label>Enlaces Web</label>
    <div id="urls-container"></div>
    
    <label>Notas</label>
    <textarea id="edit-notes" rows="4"></textarea>
    <input type="hidden" id="edit-index">
</div>

<script>
    const GITHUB_USER = "antoniodetm"; 
    const FILENAME = "mis-destinos.json";

    let trips = JSON.parse(localStorage.getItem('myTrips')) || [];
    let currentBase64 = "";
    const placeholderImg = "https://via.placeholder.com/400?text=A√±adir+Foto";

    function renderTrips() {
        const container = document.getElementById('trips-container');
        container.innerHTML = trips.length === 0 ? '<p style="text-align:center; color:gray;">Sin destinos.</p>' : '';
        trips.forEach((trip, index) => {
            container.innerHTML += `
                <div class="trip-card">
                    <img src="${trip.img || placeholderImg}" class="thumb" onclick="openDetails(${index})">
                    <div class="card-info" onclick="openDetails(${index})">
                        <span class="card-title">${trip.title}</span>
                        <div class="card-meta">üìç ${trip.provincia || '---'} ‚Ä¢ üöó ${trip.km || '0'} km</div>
                    </div>
                    <div class="card-controls">
                        <button class="order-btn" onclick="moveTrip(${index}, -1)">‚ñ≤</button>
                        <button class="delete-quick" onclick="deleteTrip(${index})">üóëÔ∏è</button>
                        <button class="order-btn" onclick="moveTrip(${index}, 1)">‚ñº</button>
                    </div>
                </div>`;
        });
    }

    // GESTI√ìN DE ENLACES (MEJORADA)
    function addUrlField(value = '') {
        const container = document.getElementById('urls-container');
        const div = document.createElement('div');
        div.className = 'url-group';
        div.innerHTML = `
            <input type="url" class="trip-url" placeholder="https://..." value="${value}">
            <button class="btn-action btn-go" onclick="goToUrl(this)">‚ûú</button>
            <button class="btn-action btn-remove" onclick="this.parentElement.remove()">‚úï</button>
            <button class="btn-action btn-add-inline" onclick="addUrlField()">+</button>
        `;
        container.appendChild(div);
    }

    function goToUrl(btn) {
        const url = btn.parentElement.querySelector('input').value;
        if (url) window.open(url.startsWith('http') ? url : 'https://' + url, '_blank');
    }

    function openDetails(index) {
        document.getElementById('list-screen').classList.remove('active');
        document.getElementById('detail-screen').classList.add('active');
        document.getElementById('urls-container').innerHTML = ''; // Limpiar siempre
        
        if (index !== null) {
            const t = trips[index];
            document.getElementById('edit-title').value = t.title || "";
            document.getElementById('edit-provincia').value = t.provincia || "";
            document.getElementById('edit-km').value = t.km || "";
            document.getElementById('edit-notes').value = t.notes || "";
            document.getElementById('preview-img').src = t.img || placeholderImg;
            currentBase64 = t.img || "";
            document.getElementById('edit-index').value = index;
            
            // Si el destino tiene enlaces, ponlos. Si no, pon uno vac√≠o.
            if (t.urls && t.urls.length > 0) {
                t.urls.forEach(u => addUrlField(u));
            } else {
                addUrlField();
            }
        } else {
            document.getElementById('edit-index').value = "new";
            document.getElementById('edit-title').value = "";
            document.getElementById('edit-provincia').value = "";
            document.getElementById('edit-km').value = "";
            document.getElementById('edit-notes').value = "";
            document.getElementById('preview-img').src = placeholderImg;
            currentBase64 = "";
            addUrlField();
        }
    }

    function saveTrip() {
        const title = document.getElementById('edit-title').value;
        if (!title) return;
        
        // Recoger todos los enlaces de los inputs
        const urls = Array.from(document.querySelectorAll('.trip-url'))
                          .map(input => input.value)
                          .filter(val => val.trim() !== "");

        const tripData = { 
            title, 
            provincia: document.getElementById('edit-provincia').value, 
            km: document.getElementById('edit-km').value, 
            img: currentBase64, 
            urls: urls, 
            notes: document.getElementById('edit-notes').value 
        };

        const idx = document.getElementById('edit-index').value;
        if(idx === "new") trips.push(tripData); else trips[idx] = tripData;
        
        saveAndRefresh();
        showList();
    }

    function saveAndRefresh() {
        localStorage.setItem('myTrips', JSON.stringify(trips));
        renderTrips();
    }

    function showList() {
        document.getElementById('detail-screen').classList.remove('active');
        document.getElementById('list-screen').classList.add('active');
    }

    function handleFile(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => { currentBase64 = e.target.result; document.getElementById('preview-img').src = currentBase64; };
            reader.readAsDataURL(input.files[0]);
        }
    }

    function deleteTrip(index) { if (confirm("¬øBorrar?")) { trips.splice(index, 1); saveAndRefresh(); } }
    function moveTrip(index, dir) { const n = index + dir; if(n >= 0 && n < trips.length){ [trips[index], trips[n]] = [trips[n], trips[index]]; saveAndRefresh(); } }
    function exportJSON() { const b = new Blob([JSON.stringify(trips, null, 2)], {type: "application/json"}); const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = FILENAME; a.click(); }
    function importJSON(input) { const r = new FileReader(); r.onload = (e) => { try { trips = JSON.parse(e.target.result); saveAndRefresh(); } catch(i){ alert("Error"); } }; r.readAsText(input.files[0]); }
    async function syncFromGitHub() { alert("Aseg√∫rate de haber subido el JSON a GitHub con el nuevo formato de enlaces."); }

    renderTrips();
</script>
</body>
</html>